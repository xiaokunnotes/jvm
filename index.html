<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="keywords" content="Java,JDK,Java source,Collection,ArrayList,Map,List,HashMap,ArrayDeque,Deque,Set,HashSet,LinkedList,Queue,TreeMap,TreeSet,Vector,Stack">
<meta name="author" content="D瓜哥">
<meta name="copyright" content="Apache-2.0">
<title>JDK 源码分析</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="assets/css/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/css/rouge-monokai.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>JDK 源码分析</h1>
<div class="details">
<span id="author" class="author">D瓜哥</span><br>
<span id="email" class="email"><a href="https://www.diguage.com" class="bare">https://www.diguage.com</a></span><br>
<span id="revdate">2020-12-10</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_前言jdk_stl_源码分析计划">前言：JDK &amp; STL 源码分析计划</a></li>
<li><a href="#_第二部分_自动内存管理实践">1. 第二部分 自动内存管理实践</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_前言jdk_stl_源码分析计划"><a class="anchor" href="#_前言jdk_stl_源码分析计划"></a>前言：JDK &amp; STL 源码分析计划</h2>
<div class="sectionbody">
<div class="paragraph">
<p>为了学好数据结构以及相关算法，同时也为了更好地理解 JDK 的底层实现，计划对 JDK 集合类的源码做一个系统的阅读分析。</p>
</div>
<div class="paragraph">
<p>欢迎随时提交 PR 或 Issue。建了一个 Gitter 聊天室，点击图标加入： <a href="https://gitter.im/source-analysis/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><span class="image"><img src="https://badges.gitter.im/source-analysis/community.svg" alt="community"></span></a>。</p>
</div>
<div class="paragraph">
<p>浏览请点击： <a href="https://diguage.github.io/jdk-source-analysis/">JDK 源码分析</a>。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
本文档基于 <strong>OpenJDK 11.0.6 2020-01-14 LTS</strong> 的代码开展分析，请 PR 的小伙伴使用相同的 JDK。谢谢！
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_友情支持"><a class="anchor" href="#_友情支持"></a>友情支持</h3>
<div class="paragraph">
<p>如果您觉得这个笔记对您有所帮助，看在D瓜哥码字的辛苦上，请友情支持一下，D瓜哥感激不尽，😜</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/alipay.png" alt="支付宝" width="45%" title="支付宝"></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/wxpay.png" alt="微信" width="45%" title="微信"></span></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
想要联系方式的小伙伴，欢迎提交 Issue 留言。D瓜哥还建了一个 Gitter 聊天室，点击图标加入： <a href="https://gitter.im/source-analysis/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><span class="image"><img src="https://badges.gitter.im/source-analysis/community.svg" alt="community"></span></a>，加入即可留言。（PS：留言不保证回复的时效性）
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_官网及版本库"><a class="anchor" href="#_官网及版本库"></a>官网及版本库</h3>
<div class="paragraph">
<p>本文档的版本库托管在 Github 上，另外单独发布。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">“地瓜哥”博客网</dt>
<dd>
<p><a href="https://www.diguage.com/" class="bare" target="_blank" rel="noopener">https://www.diguage.com/</a> 。D瓜哥的个人博客。欢迎光临，不过，内容很杂乱，请见谅。不见谅，你来打我啊，😂😂</p>
</dd>
<dt class="hdlist1">本文档官网</dt>
<dd>
<p><a href="https://diguage.github.io/jdk-source-analysis/" class="bare" target="_blank" rel="noopener">https://diguage.github.io/jdk-source-analysis/</a> 。为了方便阅读，这里展示了处理好的文档。阅读请点击这个网址。</p>
</dd>
<dt class="hdlist1">本文档版本库</dt>
<dd>
<p><a href="https://github.com/diguage/jdk-source-analysis" class="bare" target="_blank" rel="noopener">https://github.com/diguage/jdk-source-analysis</a> 。欢迎大家发送 PR。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_总体思路"><a class="anchor" href="#_总体思路"></a>总体思路</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>学习基本的数据结构认识。兵马未动粮草先行。先把基础理论搞清楚。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>学Java的，可以从下面两本书中选一本：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/26745780/">数据结构与算法分析</a>&#8201;&#8212;&#8201;这本书的优点在于和 Java JDK 的集合类很贴近。</p>
</li>
<li>
<p><a href="https://book.douban.com/subject/19952400/">算法（第4版）</a>&#8201;&#8212;&#8201;这本书胜在图很多。</p>
</li>
</ol>
</div>
</li>
<li>
<p>学 C/C++ 的，可以看下面这套书：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/4065258/">算法：C语言实现 (第1～4部分)</a></p>
</li>
<li>
<p><a href="https://book.douban.com/subject/4191525/">算法：C语言实现 （第5部分）</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>自己实现一遍基本的数据结构；</p>
</li>
<li>
<p>阅读 JDK 或 STL 源码，做学习笔记。</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
对比一下自己的实现和这些经典代码的实现，总结自己差距，提高自己的编码能力。
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://book.douban.com/subject/1110934/">STL源码剖析 </a>&#8201;&#8212;&#8201;阅读源码时，建议参考一下本书的内容。</p>
</li>
<li>
<p>建议把网上的源码分析笔记都看一看，取长补短，补充自己的分析。</p>
</li>
<li>
<p>建议把网上相关面试题也看一看，检验自己的学习成果。</p>
</li>
</ol>
</div>
</li>
<li>
<p>相关联的 LeetCode 上的题都刷掉。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>还有两个想法：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>可以把 Redis 的实现也过一下，Redis 实现也有很多不错的思路。毕竟 Redis 是目前最常用的缓存解决方案。</p>
</li>
<li>
<p>Java 中有很多针对集合类做扩展的库，可以一并学了，这样就能更清楚了解 Java JDK 实现的不足，开阔自己的眼界：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://github.com/google/guava">google/guava: Google core libraries for Java</a></p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-collections/">Apache Commons Collections</a></p>
</li>
<li>
<p><a href="https://www.eclipse.org/collections/">Eclipse Collections - Features you want with the collections you need.</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jdk_集合类"><a class="anchor" href="#_jdk_集合类"></a>JDK 集合类</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Base + Iterator</strong></dt>
<dd>
<p>代码总行数： 103 + 135 + 302 + 195 + 838 + 127 + 734 + 480 = 2914 行，预计 5 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.lang.Iterable</code></p>
</li>
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.PrimitiveIterator</code></p>
</li>
<li>
<p><code>java.util.ListIterator</code></p>
</li>
<li>
<p><code>java.util.Spliterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.util.Collection</code></p>
</li>
<li>
<p><code>java.util.AbstractCollection</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>List</strong></dt>
<dd>
<p>代码总行数： 1063 + 942 + 253 + 1266 + 1509 + 141 + 1759 = 6933 行，预计 12 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.List</code></p>
</li>
<li>
<p><code>java.util.AbstractList</code></p>
</li>
<li>
<p><code>java.util.AbstractSequentialList</code></p>
</li>
<li>
<p><code>java.util.LinkedList</code></p>
</li>
<li>
<p><code>java.util.Vector</code></p>
</li>
<li>
<p><code>java.util.Stack</code></p>
</li>
<li>
<p><code>java.util.ArrayList</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Queue</strong></dt>
<dd>
<p>代码总行数： 212 + 616 + 192 + 1233 + 987 = 3240 行，预计 6 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Queue</code></p>
</li>
<li>
<p><code>java.util.Deque</code></p>
</li>
<li>
<p><code>java.util.AbstractQueue</code></p>
</li>
<li>
<p><code>java.util.ArrayDeque</code></p>
</li>
<li>
<p><code>java.util.PriorityQueue</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Set</strong></dt>
<dd>
<p>代码总行数： 732 + 186 + 264 + 491 + 323 + 361 + 560 + 195 + 1395 = 4507 行，预计 8 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Set</code></p>
</li>
<li>
<p><code>java.util.AbstractSet</code></p>
</li>
<li>
<p><code>java.util.SortedSet</code></p>
</li>
<li>
<p><code>java.util.EnumSet</code></p>
</li>
<li>
<p><code>java.util.NavigableSet</code></p>
</li>
<li>
<p><code>java.util.HashSet</code></p>
</li>
<li>
<p><code>java.util.TreeSet</code></p>
</li>
<li>
<p><code>java.util.LinkedHashSet</code></p>
</li>
<li>
<p><code>java.util.BitSet</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Collection.png" alt="java.util.Collection">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Map</strong></dt>
<dd>
<p>代码总行数： 1687 + 284 + 424 + 857 + 3012 + 1339 + 812 + 1600 + 756 + 2444 + 155 + 1521 = 14891 行，预计 28 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Map</code></p>
</li>
<li>
<p><code>java.util.SortedMap</code></p>
</li>
<li>
<p><code>java.util.NavigableMap</code></p>
</li>
<li>
<p><code>java.util.AbstractMap</code></p>
</li>
<li>
<p><code>java.util.TreeMap</code></p>
</li>
<li>
<p><code>java.util.WeakHashMap</code></p>
</li>
<li>
<p><code>java.util.EnumMap</code></p>
</li>
<li>
<p><code>java.util.IdentityHashMap</code></p>
</li>
<li>
<p><code>java.util.LinkedHashMap</code></p>
</li>
<li>
<p><code>java.util.HashMap</code></p>
</li>
<li>
<p><code>java.util.Dictionary</code></p>
</li>
<li>
<p><code>java.util.Hashtable</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Map.png" alt="java.util.Map">
</div>
</div>
<div class="paragraph">
<p>来张总体结构图：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jdk-collection-classes.png" alt="jdk collection classes">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
这里没有包含并发相关的集合类。这块内容放到并发中一起搞。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_第二部分_自动内存管理实践"><a class="anchor" href="#_第二部分_自动内存管理实践"></a>1. 第二部分 自动内存管理实践</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/runing.png" alt="runing">
</div>
</div>
<div class="sect2">
<h3 id="_程序计数器program_counter_register"><a class="anchor" href="#_程序计数器program_counter_register"></a>1.1. 程序计数器（Program Counter Register）</h3>
<div class="paragraph">
<p>程序计数器主要存储当前线程所执行的字节码行号指示器，通过改变计数器的值来获取下一条需要执行的字节码指令。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>首先我们要搞清楚JVM的多线程实现方式。JVM的多线程是通过CPU时间片轮转（即线程轮流切换并分配处理器执行时间）算法来实现的。也就是说，某个线程在执行过程中可能会因为时间片耗尽而被挂起，而另一个线程获取到时间片开始执行。当被挂起的线程重新获取到时间片的时候，它要想从被挂起的地方继续执行，就必须知道它上次执行到哪个位置，在JVM中，通过程序计数器来记录某个线程的字节码执行位置。因此，程序计数器是具备线程隔离的特性，也就是说，每个线程工作时都有属于自己的独立计数器。</pre>
</div>
</div>
<div class="paragraph">
<p>特点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>线程隔离性,每个线程有自己的独立技术器。</p>
</li>
<li>
<p>执行java方法时，计数器中记录的是正在执行的虚拟机字节码指令地址</p>
</li>
<li>
<p>执行native方法时，计数器值为空。why? native方法大多是通过C实现的并未编译成需要执行的字节码指令，也就不需要存储执行指令地址了。</p>
</li>
<li>
<p>jvm规范中唯一没有规定OutOfMemoryError情况的区域</p>
</li>
<li>
<p>占用内存很小，可忽略不计</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_虚拟机栈vm_stack"><a class="anchor" href="#_虚拟机栈vm_stack"></a>1.2. 虚拟机栈（VM Stack）</h3>
<div class="paragraph">
<p>虚拟机栈描述的是Java方法执行的线程内存模型，存放的是一个方法的所有局部变量。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>每个方法被执行的时候，虚拟机栈都会同步创建一个栈帧（Stack Frame） 用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法被调用直至执行完毕的过程就对应着一个栈帧在虚拟机中从入栈到出栈的过程</pre>
</div>
</div>
<div class="paragraph">
<p>下面我们用这段代码介绍下虚拟机栈结构及用途</p>
</div>
<div class="listingblock">
<div class="title">VmStackDome.java</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VmStackDome</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodOne</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">){</span>

      <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">;</span>
      <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
      <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
      <span class="n">methodTwo</span><span class="o">();</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodTwo</span><span class="o">(){</span>
      <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"k="</span><span class="o">+</span><span class="n">k</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>当虚拟机要执行一个方法methodOne()时，就会有一个栈帧压入线程独享的虚拟机栈中，如下图</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ruzhanguocheng.png" alt="ruzhanguocheng">
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>当线程开始执行这个方法时这些局部变量应该从哪里读取，又是在哪里做的运算？我们通过看这个类的反编译代码来看</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/bianyi.png" alt="bianyi">
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>我们直接看这个方法的执行区，可以看到在执行int j=1;时对应的执行指令是iconst_1,我们再参考Java虚拟机字节码指令表看，iconst_1的含义是将int型1推送至栈顶</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/iconst_1.png" alt="iconst 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/iconst_1-2.png" alt="iconst 1 2">
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>第二步执行istore_2指令,指令含义：将栈顶int型数值存入第三个本地变量</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/istore.png" alt="istore">
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>执行iload_1指令（将第二个int型本地变量推送至栈顶）、iload_2（将第三个int型本地变量推送至栈顶）假设 i=10;</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/iload.png" alt="iload">
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>执行iadd指令(将栈顶两int型数值相加并将结果压入栈顶)、执行istore_3（将栈顶int型数值存入第四个本地变量）</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/iadd.png" alt="iadd">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-12-10 12:09:34 UTC
</div>
</div>
</body>
</html>